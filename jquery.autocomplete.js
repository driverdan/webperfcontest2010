/*
 * Autocomplete - jQuery plugin 1.1pre
 *
 * Copyright (c) 2007 Dylan Verheul, Dan G. Switzer, Anjesh Tuladhar, JÃ¶rn Zaefferer
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 *
 * Revision: $Id: jquery.autocomplete.js,v 1.1.2.2 2009/08/18 09:40:53 apoumarat Exp $
 *
 */

;(function($){$.fn.extend({autocomplete:function(b,c){var d=typeof b=="string";c=$.extend({},$.Autocompleter.defaults,{url:d?b:null,data:d?null:b,delay:d?$.Autocompleter.defaults.delay:10,max:c&&!c.scroll?10:150},c);c.highlight=c.highlight||function(a){return a};c.formatMatch=c.formatMatch||c.formatItem;return this.each(function(){new $.Autocompleter(this,c)})},result:function(a){return this.bind("result",a)},search:function(a){return this.trigger("search",[a])},flushCache:function(){return this.trigger("flushCache")},setOptions:function(a){return this.trigger("setOptions",[a])},unautocomplete:function(){return this.trigger("unautocomplete")}});$.Autocompleter=function(h,j){var k={UP:38,DOWN:40,DEL:46,TAB:9,RETURN:13,ESC:27,COMMA:188,PAGEUP:33,PAGEDOWN:34,BACKSPACE:8},$input=$(h).attr("autocomplete","off").addClass(j.inputClass),timeout,previousValue="",cache=$.Autocompleter.Cache(j),hasFocus=0,lastKeyPressCode,config={mouseDownOnSelect:false},select=$.Autocompleter.Select(j,h,selectCurrent,config),blockSubmit;$.browser.opera&&$(h.form).bind("submit.autocomplete",function(){if(blockSubmit){blockSubmit=false;return false}});$input.bind(($.browser.opera?"keypress":"keydown")+".autocomplete",function(a){lastKeyPressCode=a.keyCode;switch(a.keyCode){case k.UP:a.preventDefault();if(select.visible()){select.prev()}else{onChange(0,true)}break;case k.DOWN:a.preventDefault();if(select.visible()){select.next()}else{onChange(0,true)}break;case k.PAGEUP:a.preventDefault();if(select.visible()){select.pageUp()}else{onChange(0,true)}break;case k.PAGEDOWN:a.preventDefault();if(select.visible()){select.pageDown()}else{onChange(0,true)}break;case j.multiple&&$.trim(j.multipleSeparator)==","&&k.COMMA:case k.TAB:case k.RETURN:if(selectCurrent()){a.preventDefault();blockSubmit=true;return false}break;case k.ESC:select.hide();break;default:clearTimeout(timeout);timeout=setTimeout(onChange,j.delay);break}}).focus(function(){hasFocus++}).blur(function(){hasFocus=0;if(!config.mouseDownOnSelect){hideResults()}}).click(function(){if(hasFocus++>1&&!select.visible()){onChange(0,true)}}).bind("search",function(){var c=(arguments.length>1)?arguments[1]:null;function findValueCallback(q,a){var b,i;if(a&&a.length){for(i=0;i<a.length;i++){if(a[i].result.toLowerCase()==q.toLowerCase()){b=a[i];break}}}if(typeof c=="function")c(b);else $input.trigger("result",b&&[b.data,b.value])}$.each(trimWords($input.val()),function(i,a){request(a,findValueCallback,findValueCallback)})}).bind("flushCache",function(){cache.flush()}).bind("setOptions",function(){$.extend(j,arguments[1]);if("data"in arguments[1])cache.populate()}).bind("unautocomplete",function(){select.unbind();$input.unbind();$(h.form).unbind(".autocomplete")});function selectCurrent(){var a=select.selected(),v,words;if(!a)return false;v=a.result;previousValue=v;if(j.multiple){words=trimWords($input.val());if(words.length>1){v=words.slice(0,words.length-1).join(j.multipleSeparator)+j.multipleSeparator+v}v+=j.multipleSeparator}$input.val(v);hideResultsNow();$input.trigger("result",[a.data,a.value]);return true}function onChange(a,b){if(lastKeyPressCode==k.DEL){select.hide();return}var c=$input.val();if(!b&&c==previousValue)return;previousValue=c;c=lastWord(c);if(c.length>=j.minChars){$input.addClass(j.loadingClass);if(!j.matchCase)c=c.toLowerCase();request(c,receiveData,hideResultsNow)}else{stopLoading();select.hide()}};function trimWords(b){if(!b){return[""]}var c=b.split(j.multipleSeparator),result=[];$.each(c,function(i,a){if($.trim(a))result[i]=$.trim(a)});return result}function lastWord(a){if(!j.multiple)return a;var b=trimWords(a);return b[b.length-1]}function autoFill(q,a){if(j.autoFill&&(lastWord($input.val()).toLowerCase()==q.toLowerCase())&&lastKeyPressCode!=k.BACKSPACE){$input.val($input.val()+a.substring(lastWord(previousValue).length));$.Autocompleter.Selection(h,previousValue.length,previousValue.length+a.length)}};function hideResults(){clearTimeout(timeout);timeout=setTimeout(hideResultsNow,200)};function hideResultsNow(){var c=select.visible();select.hide();clearTimeout(timeout);stopLoading();if(j.mustMatch){$input.search(function(a){if(!a){if(j.multiple){var b=trimWords($input.val()).slice(0,-1);$input.val(b.join(j.multipleSeparator)+(b.length?j.multipleSeparator:""))}else $input.val("")}})}if(c)$.Autocompleter.Selection(h,h.value.length,h.value.length)};function receiveData(q,a){if(a&&a.length&&hasFocus){stopLoading();select.display(a,q);autoFill(q,a[0].value);select.show()}else{hideResultsNow()}};function request(c,d,e){if(!j.matchCase)c=c.toLowerCase();var f=cache.load(c);if(f&&f.length){d(c,f)}else if((typeof j.url=="string")&&(j.url.length>0)){var g={timestamp:+new Date()};$.each(j.extraParams,function(a,b){g[a]=typeof b=="function"?b():b});$.ajax({mode:"abort",port:"autocomplete"+h.name,dataType:j.dataType,url:j.url,data:$.extend({q:lastWord(c),limit:j.max},g),success:function(a){var b=j.parse&&j.parse(a)||parse(a);cache.add(c,b);d(c,b)}})}else{select.emptyList();e(c)}};function parse(a){var b=[],rows=a.split("\n"),i,row;for(i=0;i<rows.length;i++){row=$.trim(rows[i]);if(row){row=row.split("|");b[b.length]={data:row,value:row[0],result:j.formatResult&&j.formatResult(row,row[0])||row[0]}}}return b};function stopLoading(){$input.removeClass(j.loadingClass)}};$.Autocompleter.defaults={inputClass:"ac_input",resultsClass:"ac_results",loadingClass:"ac_loading",minChars:1,delay:400,matchCase:false,matchSubset:true,matchContains:false,cacheLength:10,max:100,mustMatch:false,extraParams:{},selectFirst:true,formatItem:function(a){return a[0]},formatMatch:null,autoFill:false,width:0,multiple:false,multipleSeparator:", ",highlight:function(a,b){return a.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+b.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:true,scrollHeight:180};$.Autocompleter.Cache=function(d){var e={},length=0;function matchSubset(s,a){if(!d.matchCase)s=s.toLowerCase();var i=s.indexOf(a);if(d.matchContains=="word"){i=s.toLowerCase().search("\\b"+a.toLowerCase())}if(i==-1)return false;return i==0||d.matchContains};function add(q,a){if(length>d.cacheLength){flush()}if(!e[q]){length++}e[q]=a}function populate(){if(!d.data)return false;var b={},nullData=0,i,rawValue,value,firstChar,raw;if(!d.url)d.cacheLength=1;b[""]=[];for(i=0,ol=d.data.length;i<ol;i++){rawValue=d.data[i];rawValue=(typeof rawValue=="string")?[rawValue]:rawValue;value=d.formatMatch(rawValue,i+1,d.data.length);if(value===false)continue;firstChar=value.charAt(0).toLowerCase();if(!b[firstChar])b[firstChar]=[];row={value:value,data:rawValue,result:d.formatResult&&d.formatResult(rawValue)||value};b[firstChar].push(row);if(nullData++<d.max){b[""].push(row)}};$.each(b,function(i,a){d.cacheLength++;add(i,a)})}setTimeout(populate,25);function flush(){e={};length=0}return{flush:flush,add:add,populate:populate,load:function(q){if(!d.cacheLength||!length)return null;if(!d.url&&d.matchContains){var a=[],k,c;for(k in e){if(k.length>0){c=e[k];$.each(c,function(i,x){if(matchSubset(x.value,q)){a.push(x)}})}}return a}else if(e[q]){return e[q]}else if(d.matchSubset){for(var i=q.length-1;i>=d.minChars;i--){var c=e[q.substr(0,i)];if(c){var a=[];$.each(c,function(i,x){if(matchSubset(x.value,q)){a[a.length]=x}});return a}}}return null}}};$.Autocompleter.Select=function(c,e,f,g){var h={ACTIVE:"ac_over"},listItems,active=-1,data,term="",needsInit=true,element,list;function init(){if(!needsInit)return;element=$("<div/>").hide().addClass(c.resultsClass).css("position","absolute").appendTo(document.body);list=$("<ul/>").appendTo(element).mouseover(function(a){if(target(a).nodeName&&target(a).nodeName.toUpperCase()=='LI'){active=$("li",list).removeClass(h.ACTIVE).index(target(a));$(target(a)).addClass(h.ACTIVE)}}).click(function(a){$(target(a)).addClass(h.ACTIVE);f();e.focus();return false}).mousedown(function(){g.mouseDownOnSelect=true}).mouseup(function(){g.mouseDownOnSelect=false});if(c.width>0)element.css("width",c.width);needsInit=false}function target(a){var b=a.target;while(b&&b.tagName!="LI")b=b.parentNode;if(!b)return[];return b}function moveSelect(a){listItems.slice(active,active+1).removeClass(h.ACTIVE);movePosition(a);var b=listItems.slice(active,active+1).addClass(h.ACTIVE),offset;if(c.scroll){offset=0;listItems.slice(0,active).each(function(){offset+=this.offsetHeight});if((offset+b[0].offsetHeight-list.scrollTop())>list[0].clientHeight){list.scrollTop(offset+b[0].offsetHeight-list.innerHeight())}else if(offset<list.scrollTop()){list.scrollTop(offset)}}};function movePosition(a){active+=a;if(active<0){active=listItems.size()-1}else if(active>=listItems.size()){active=0}}function limitNumberOfItems(a){return c.max&&c.max<a?c.max:a}function fillList(){list.empty();var a=limitNumberOfItems(data.length),i,formatted,li;for(i=0;i<a;i++){if(!data[i])continue;formatted=c.formatItem(data[i].data,i+1,a,data[i].value,term);if(formatted===false)continue;li=$("<li/>").html(c.highlight(formatted,term)).addClass(i%2==0?"ac_even":"ac_odd").appendTo(list)[0];$.data(li,"ac_data",data[i])}listItems=list.find("li");if(c.selectFirst){listItems.slice(0,1).addClass(h.ACTIVE);active=0}if($.fn.bgiframe)list.bgiframe()}return{display:function(d,q){init();data=d;term=q;fillList()},next:function(){moveSelect(1)},prev:function(){moveSelect(-1)},pageUp:function(){if(active!=0&&active-8<0){moveSelect(-active)}else{moveSelect(-8)}},pageDown:function(){if(active!=listItems.size()-1&&active+8>listItems.size()){moveSelect(listItems.size()-1-active)}else{moveSelect(8)}},hide:function(){element&&element.hide();listItems&&listItems.removeClass(h.ACTIVE);active=-1},visible:function(){return element&&element.is(":visible")},current:function(){return this.visible()&&(listItems.filter("."+h.ACTIVE)[0]||c.selectFirst&&listItems[0])},show:function(){var a=$(e).offset(),listHeight,scrollbarsVisible;element.css({width:typeof c.width=="string"||c.width>0?c.width:$(e).width(),top:a.top+e.offsetHeight,left:a.left}).show();if(c.scroll){list.scrollTop(0);list.css({maxHeight:c.scrollHeight,overflow:'auto'});if($.browser.msie&&typeof document.body.style.maxHeight==="undefined"){listHeight=0;listItems.each(function(){listHeight+=this.offsetHeight});scrollbarsVisible=listHeight>c.scrollHeight;list.css('height',scrollbarsVisible?c.scrollHeight:listHeight);if(!scrollbarsVisible){listItems.width(list.width()-parseInt(listItems.css("padding-left"))-parseInt(listItems.css("padding-right")))}}}},selected:function(){var a=listItems&&listItems.filter("."+h.ACTIVE).removeClass(h.ACTIVE);return a&&a.length&&$.data(a[0],"ac_data")},emptyList:function(){list&&list.empty()},unbind:function(){element&&element.remove()}}};$.Autocompleter.Selection=function(a,b,c){if(a.createTextRange){var d=a.createTextRange();d.collapse(true);d.moveStart("character",b);d.moveEnd("character",c);d.select()}else if(a.setSelectionRange){a.setSelectionRange(b,c)}else{if(a.selectionStart){a.selectionStart=b;a.selectionEnd=c}}a.focus()}})(jQuery);